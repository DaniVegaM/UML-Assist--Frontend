import { useReactFlow, MarkerType } from "@xyflow/react";
import "react-contexify/dist/ReactContexify.css";

interface ChangeEdgeTypeProps {
    onClose: () => void;
    edgeId: string | null;
}

const EDGE_TYPES = {
    sync: {
        label: "Mensaje Síncrono",
        config: {
            edgeType: 'sync',
            style: {
                strokeWidth: 2,
                strokeDasharray: 'none'
            },
            markerEnd: {
                type: MarkerType.ArrowClosed,
                width: 20,
                height: 20,
            }
        }
    },
    async: {
        label: "Mensaje Asíncrono",
        config: {
            edgeType: 'async',
            style: {
                strokeWidth: 2,
                strokeDasharray: 'none'
            },
            markerEnd: {
                type: MarkerType.Arrow,
                width: 20,
                height: 20,
            }
        }
    },
    response: {
        label: "Mensaje de Respuesta",
        config: {
            edgeType: 'response',
            style: {
                strokeWidth: 2,
                strokeDasharray: '5,5'
            },
            markerEnd: {
                type: MarkerType.Arrow,
                width: 20,
                height: 20,
            }
        }
    }
};

export default function ChangeEdgeType({ onClose, edgeId }: ChangeEdgeTypeProps) {
    const { setEdges } = useReactFlow();

    const handleEdgeTypeChange = (type: keyof typeof EDGE_TYPES) => {
        if (!edgeId) return;

        const { config } = EDGE_TYPES[type];

        setEdges(prev =>
            prev.map(edge => {
                if (edge.id === edgeId) {
                    return {
                        ...edge,
                        data: {
                            ...edge.data,
                            edgeType: config.edgeType
                        },
                        style: {
                            ...config.style,
                            stroke: edge.style?.stroke
                        },
                        markerEnd: {
                            ...config.markerEnd,
                            color: typeof edge.markerEnd === 'object' ? edge.markerEnd.color : undefined
                        }
                    };
                }
                return edge;
            })
        );

        onClose();
    };

    return (
        <div className="bg-white dark:bg-neutral-800 rounded-lg shadow-xl border border-sky-600 dark:border-neutral-700 min-w-[220px] overflow-hidden">
            {Object.entries(EDGE_TYPES).map(([key, { label }], index) => (
                <div key={key}>
                    <div
                        onClick={() => handleEdgeTypeChange(key as keyof typeof EDGE_TYPES)}
                        className="flex items-center gap-3 px-4 py-2 hover:bg-sky-100 dark:hover:bg-neutral-700 cursor-pointer text-sm dark:text-white"
                    >
                        <div className="w-12 h-6 flex items-center justify-center">
                            {label === 'Mensaje Síncrono' && (
                                <svg className="w-full h-full" width="116" height="23" viewBox="0 0 116 23" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M110.707 12.7069C111.098 12.3163 111.098 11.6832 110.707 11.2927L104.343 4.92897C103.952 4.53846 103.319 4.53848 102.929 4.92903C102.538 5.31957 102.538 5.95273 102.929 6.34324L108.586 11.9999L102.929 17.6569C102.539 18.0475 102.539 18.6807 102.929 19.0712C103.32 19.4617 103.953 19.4616 104.344 19.0711L110.707 12.7069ZM6.10336e-05 12.0045L0.000103643 13.0045L110 12.9998L110 11.9998L110 10.9998L1.84241e-05 11.0045L6.10336e-05 12.0045Z" fill="black" />
                                    <path d="M116 11.5L100.25 21.4593V1.54071L116 11.5Z" fill="black" />
                                </svg>
                            )}
                            {label === 'Mensaje Asíncrono' && (
                                <svg className="w-full h-full" width="112" height="20" viewBox="0 0 112 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M110.707 10.707C111.098 10.3165 111.098 9.68332 110.707 9.29281L104.343 2.92912C103.952 2.53862 103.319 2.53864 102.929 2.92919C102.538 3.31973 102.538 3.95289 102.929 4.3434L108.586 10L102.929 15.6571C102.539 16.0476 102.539 16.6808 102.929 17.0713C103.32 17.4618 103.953 17.4618 104.344 17.0713L110.707 10.707ZM6.10352e-05 10.0046L0.000103645 11.0046L110 11L110 9.99995L110 8.99995L1.84257e-05 9.00464L6.10352e-05 10.0046Z" fill="black" />
                                    <line x1="110.455" y1="10.5767" x2="100.939" y2="1.06068" stroke="black" strokeWidth="3" />
                                    <line x1="110.577" y1="9.06066" x2="101.061" y2="18.5766" stroke="black" strokeWidth="3" />
                                </svg>
                            )}
                            {label === 'Mensaje de Respuesta' && (
                                <svg className="w-full h-full" width="115" height="20" viewBox="0 0 115 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M113.722 10.7008C114.109 10.307 114.104 9.67383 113.71 9.28668L107.291 2.97782C106.897 2.59067 106.264 2.59613 105.877 2.99001C105.49 3.38389 105.495 4.01703 105.889 4.40417L111.595 10.0121L105.987 15.7175C105.6 16.1113 105.605 16.7445 105.999 17.1316C106.393 17.5188 107.026 17.5133 107.413 17.1194L113.722 10.7008ZM0.00860596 10.974L0.0172263 11.974L2.03509 11.9566L2.02647 10.9566L2.01785 9.95664L-1.44122e-05 9.97404L0.00860596 10.974ZM6.06219 10.9218L6.07081 11.9218L10.1065 11.887L10.0979 10.887L10.0893 9.88706L6.05357 9.92185L6.06219 10.9218ZM14.1336 10.8522L14.1423 11.8522L18.178 11.8174L18.1694 10.8174L18.1607 9.81748L14.125 9.85227L14.1336 10.8522ZM22.2051 10.7827L22.2137 11.7826L26.2494 11.7478L26.2408 10.7479L26.2322 9.7479L22.1965 9.78269L22.2051 10.7827ZM30.2765 10.7131L30.2852 11.713L34.3209 11.6782L34.3123 10.6783L34.3036 9.67832L30.2679 9.71311L30.2765 10.7131ZM38.348 10.6435L38.3566 11.6435L42.3923 11.6087L42.3837 10.6087L42.3751 9.60873L38.3394 9.64352L38.348 10.6435ZM46.4194 10.5739L46.428 11.5739L50.4638 11.5391L50.4551 10.5391L50.4465 9.53915L46.4108 9.57394L46.4194 10.5739ZM54.4909 10.5043L54.4995 11.5043L58.5352 11.4695L58.5266 10.4695L58.518 9.46957L54.4822 9.50436L54.4909 10.5043ZM62.5623 10.4347L62.5709 11.4347L66.6067 11.3999L66.598 10.4L66.5894 9.39999L62.5537 9.43478L62.5623 10.4347ZM70.6338 10.3652L70.6424 11.3651L74.6781 11.3303L74.6695 10.3304L74.6609 9.33041L70.6251 9.3652L70.6338 10.3652ZM78.7052 10.2956L78.7138 11.2955L82.7496 11.2608L82.7409 10.2608L82.7323 9.26083L78.6966 9.29562L78.7052 10.2956ZM86.7767 10.226L86.7853 11.226L90.821 11.1912L90.8124 10.1912L90.8038 9.19125L86.768 9.22604L86.7767 10.226ZM94.8481 10.1564L94.8567 11.1564L98.8924 11.1216L98.8838 10.1216L98.8752 9.12166L94.8395 9.15645L94.8481 10.1564ZM102.92 10.0868L102.928 11.0868L106.964 11.052L106.955 10.052L106.947 9.05208L102.911 9.08687L102.92 10.0868ZM110.991 10.0173L111 11.0172L113.017 10.9998L113.009 9.99986L113 8.9999L110.982 9.01729L110.991 10.0173ZM113.722 10.7008C114.109 10.307 114.104 9.67383 113.71 9.28668L107.291 2.97782C106.897 2.59067 106.264 2.59613 105.877 2.99001C105.49 3.38389 105.495 4.01703 105.889 4.40417L111.595 10.0121L105.987 15.7175C105.6 16.1113 105.605 16.7445 105.999 17.1316C106.393 17.5188 107.026 17.5133 107.413 17.1194L113.722 10.7008ZM0.00860596 10.974L0.0172263 11.974L2.03509 11.9566L2.02647 10.9566L2.01785 9.95664L-1.44122e-05 9.97404L0.00860596 10.974ZM6.06219 10.9218L6.07081 11.9218L10.1065 11.887L10.0979 10.887L10.0893 9.88706L6.05357 9.92185L6.06219 10.9218ZM14.1336 10.8522L14.1423 11.8522L18.178 11.8174L18.1694 10.8174L18.1607 9.81748L14.125 9.85227L14.1336 10.8522ZM22.2051 10.7827L22.2137 11.7826L26.2494 11.7478L26.2408 10.7479L26.2322 9.7479L22.1965 9.78269L22.2051 10.7827ZM30.2765 10.7131L30.2852 11.713L34.3209 11.6782L34.3123 10.6783L34.3036 9.67832L30.2679 9.71311L30.2765 10.7131ZM38.348 10.6435L38.3566 11.6435L42.3923 11.6087L42.3837 10.6087L42.3751 9.60873L38.3394 9.64352L38.348 10.6435ZM46.4194 10.5739L46.428 11.5739L50.4638 11.5391L50.4551 10.5391L50.4465 9.53915L46.4108 9.57394L46.4194 10.5739ZM54.4909 10.5043L54.4995 11.5043L58.5352 11.4695L58.5266 10.4695L58.518 9.46957L54.4822 9.50436L54.4909 10.5043ZM62.5623 10.4347L62.5709 11.4347L66.6067 11.3999L66.598 10.4L66.5894 9.39999L62.5537 9.43478L62.5623 10.4347ZM70.6338 10.3652L70.6424 11.3651L74.6781 11.3303L74.6695 10.3304L74.6609 9.33041L70.6251 9.3652L70.6338 10.3652ZM78.7052 10.2956L78.7138 11.2955L82.7496 11.2608L82.7409 10.2608L82.7323 9.26083L78.6966 9.29562L78.7052 10.2956ZM86.7767 10.226L86.7853 11.226L90.821 11.1912L90.8124 10.1912L90.8038 9.19125L86.768 9.22604L86.7767 10.226ZM94.8481 10.1564L94.8567 11.1564L98.8924 11.1216L98.8838 10.1216L98.8752 9.12166L94.8395 9.15645L94.8481 10.1564ZM102.92 10.0868L102.928 11.0868L106.964 11.052L106.955 10.052L106.947 9.05208L102.911 9.08687L102.92 10.0868ZM110.991 10.0173L111 11.0172L113.017 10.9998L113.009 9.99986L113 8.9999L110.982 9.01729L110.991 10.0173Z" fill="black" />
                                    <line x1="113.464" y1="10.5767" x2="103.948" y2="1.06068" stroke="black" strokeWidth="3" />
                                    <line x1="113.585" y1="9.06066" x2="104.069" y2="18.5766" stroke="black" strokeWidth="3" />
                                </svg>
                            )}
                        </div>
                        <p>{label}</p>
                    </div>
                    {index < Object.entries(EDGE_TYPES).length - 1 && (
                        <div className="border-b border-sky-600 dark:border-neutral-700"></div>
                    )}
                </div>
            ))}
        </div>
    )
}
